# Antibiotic resistance gens and phage defense systems analysis scripts

This repository contains all scripts required to reproduce the analysis from manuscript 'Plasmids link antibiotic resistance genes and phage defense systems in E. coli'.

## Overview

The pipeline performs the following analyses:
1. Genome annotation using Bakta
2. Phage-defense system identification using DefenseFinder
3. Antimicrobial resistance gene detection using AMRFinderPlus
4. Metadata enrichment and filtering for *E. coli* isolates
5. Statistical analysis and figure generation in R

## Prerequisites

### Software Requirements
- Python 3.10+
- R 4.0+ with packages listed in `R_analysis_scripts/dependencies.R`
- Conda/Miniconda (for environment management)
- AMRFinderPlus v4.0.23+ (via conda)
- DefenseFinder (via pip)
- Bakta API access (for genome annotation)

### Python Dependencies
All Python scripts use only standard library modules (csv, os, json, argparse, pathlib) with the following exceptions:
- `bakta_api_runner.py`: requires `requests`, `pandas`
- `metadata_handling/create_metadata_updated_ecoli_systems_detail.py`: requires `pandas`

Install additional dependencies:
```bash
pip install requests pandas
```

## Data Requirements

To reproduce this study, you need:

1. **FASTA assembly files**: Download from Zenodo
   - DOI: [10.5281/zenodo.7948130] (link: https://doi.org/10.5281/zenodo.7948130)
   - These files should be placed in an `assemblies/` folder at the project root

2. **Initial metadata file**: Supplementary File 3 from Matlock et al. 2023
   - Paper: [Enterobacterales plasmid sharing amongst human bloodstream infections, livestock, wastewater, and waterway niches in Oxfordshire, UK](https://doi.org/10.7554/eLife.85302)
   - Place the CSV file in the `assemblies/` folder and rename to `metadata_updated.csv`

## Directory Structure

```
assemblies/              # FASTA files and metadata (user-provided)
│   ├── *.fasta             # Assembly files from Zenodo
│   └── metadata_updated.csv # Supplementary File 3 from paper
├── scripts/                # This directory
│   ├── bakta_api_runner.py
│   ├── extract_bakta_parameters.py
│   ├── run_amrfinder.py
│   ├── run_defensefinder_analysis.sh
│   ├── metadata_handling/
│   └── R_analysis_scripts/
└── figures/                # Generated by R analysis scripts
```

## Pipeline Execution Order

The pipeline must be executed in the following order:

### A: Genome Annotation and Analysis
Run these scripts from the `assemblies/` directory where FASTA files are located:

1. **Bakta annotation** (genome annotation)
2. **DefenseFinder analysis** (phage-defense system detection)
3. **AMRFinderPlus analysis** (ARG detection)

### B: Metadata Processing
Run these Python scripts from the project root to enrich and filter metadata:

4. **Add DefenseFinder columns**
5. **Add AMR/IS columns**
6. **Add gene counts**
7. **Add system length**
8. **Filter for *E. coli* isolates**
9. **Split by plasmid/chromosome type**
10. **Create detailed systems metadata**

### C: Statistical Analysis and Figure Generation
Run R analysis scripts to generate figures (figure numbers are referenced in the code):

11. **Run R analysis scripts** (see R_analysis_scripts section below)

---

## Detailed Script Descriptions

### Annotation and Analysis Scripts

#### `bakta_api_runner.py`
**Purpose**: Master script for running Bakta genome annotation via API on multiple FASTA files.

**Features**:
- Automated job submission with parameter extraction
- Concurrent processing with configurable batch sizes
- Downloads JSON.gz annotation results

**Usage**:
```bash
# First, extract parameters from FASTA files
python extract_bakta_parameters.py

# Then run Bakta API with extracted parameters
python bakta_api_runner.py --max-concurrent 3 --batch-size 5

# Optional: dry run to test without API calls
python bakta_api_runner.py --dry-run
```

**Options**:
- `--dry-run`: Test mode without actual API calls
- `--max-concurrent N`: Maximum concurrent jobs (default: 5)
- `--batch-size N`: Batch size for processing (default: 10)
- `--params-file`: Path to parameters JSON file
- `--replicon-file`: Path to replicon table CSV file

**Output**:
- `bakta_results/{contig}_bakta_results.json.gz`: Annotation results per contig
- `bakta_run_report.txt`: Summary report of successful/failed jobs

---

#### `extract_bakta_parameters.py`
**Purpose**: Extract taxonomic and structural parameters from FASTA files for Bakta annotation.

**Function**: Analyzes FASTA headers to extract:
- Genus, species, strain information
- Sequence circularity (for plasmid/chromosome identification)
- Replicon table data for multi-contig genomes

**Usage**:
```bash
python extract_bakta_parameters.py
```

**Output**:
- `bakta_params/bakta_parameters.json`: Extracted parameters for each file
- `bakta_params/replicons.csv`: Replicon table

---

#### `run_defensefinder_analysis.sh`
**Purpose**: Runs DefenseFinder on all FASTA files to identify bacterial phage-defense systems.

**Features**:
- Automatic conda environment setup
- DefenseFinder installation and database updates
- Batch processing of all FASTA files
- Summary statistics generation

**Usage**:
```bash
cd assemblies/
bash ../scripts/run_defensefinder_analysis.sh
```

**Output**:
- `{contig}_defense_finder_systems.tsv`: Defense systems per contig used for downstream analysis
- `{contig}_defense_finder_genes.tsv`: 
- `{contig}_defense_finder_hmmer.tsv`: 
- `total-system-number.tsv`: Summary counts

**Requirements**:
- Conda/Miniconda installed

---

#### `run_amrfinder.py`
**Purpose**: Runs AMRFinderPlus directly on FASTA files to detect antimicrobial resistance genes with detailed Element Type and Subtype information.

**Features**:
- Parallel processing of multiple FASTA files
- Optional filtering to process only *E. coli* sequences
- Test mode for validation
- Comprehensive AMR annotation including drug classes and resistance mechanisms

**Usage**:
```bash
cd scripts/
python run_amrfinder.py [options]

# Test on first 10 files
python run_amrfinder.py --test-run

# Process only E. coli sequences
python run_amrfinder.py --filter-metadata ../assemblies/metadata_updated_ecoli.csv

# Increase parallelism
python run_amrfinder.py --max-workers 8
```

**Options**:
- `--test-run`: Test on first 10 files only
- `--max-workers N`: Number of parallel workers (default: 4)
- `--organism ORGANISM`: AMRFinderPlus organism (default: Escherichia)
- `--filter-metadata FILE`: Only process files listed in metadata CSV

**Output**:
- `amrfinder_results/{contig}_amrfinder.tsv`: Individual AMR results per contig
- `amrfinder_combined_results.csv`: Combined results with all contigs

**Requirements**:
- AMRFinderPlus installed via conda:
  ```bash
  conda create -n amrfinder ncbi-amrfinderplus -c bioconda
  conda activate amrfinder
  ```

---

### Metadata Handling Scripts

All metadata handling scripts are located in `metadata_handling/` and should be run from the project root directory after annotation/analysis tools have completed.

#### `add_defensefinder_columns.py`
**Purpose**: Adds DefenseFinder summary columns to the metadata CSV.

**Columns added**:
- `systems_count`: Number of defense systems detected per contig
- `defensefinder`: Comma-separated list of system subtypes
- `systems_gene_count`: Total genes in all systems

**Usage**:
```bash
python metadata_handling/add_defensefinder_columns.py \
  -i assemblies/metadata_updated.csv \
  -o assemblies/metadata_updated.csv
```

---

#### `add_amr_is_columns.py`
**Purpose**: Adds AMR (antimicrobial resistance) and IS (insertion sequence) summary columns.

**Columns added**:
- `AMR_count`: Count of AMR genes from AMRFinderPlus
- `IS_count`: Count of insertion sequences from Abricate-ISfinder
- `IS_density`: IS count per 10 kb of sequence length
- `AMR_binary_presence`: 1 if any AMR genes detected, else 0
- `AMR_presence`: "present" or "absent"
- `systems_binary_presence`: 1 if any defense systems detected, else 0
- `systems_presence`: "present" or "absent"

**Usage**:
```bash
python metadata_handling/add_amr_is_columns.py \
  -i assemblies/metadata_updated.csv \
  -o assemblies/metadata_updated.csv
```

---

#### `add_gene_counts.py`
**Purpose**: Adds total gene count information to the metadata CSV.

**Columns added**:
- `gene_count`: Total number of genes per contig

**Usage**:
```bash
python metadata_handling/add_gene_counts.py \
  -i assemblies/metadata_updated.csv \
  -o assemblies/metadata_updated.csv
```

---

#### `add_system_length.py`
**Purpose**: Calculates and adds defense system length metrics.

**Columns added**:
- `system_length`: Length of each defense system (bp)

**Usage**:
```bash
python metadata_handling/add_system_length.py \
  -i assemblies/metadata_updated.csv \
  -o assemblies/metadata_updated.csv
```

---

#### `filter_ecoli.py`
**Purpose**: Filters metadata to retain only *E. coli* isolates (where `mlst-PubMLST == "ecoli"`).

**Usage**:
```bash
python metadata_handling/filter_ecoli.py \
  -i assemblies/metadata_updated.csv \
  -o assemblies/metadata_updated_ecoli.csv
```

**Output**:
- `metadata_updated_ecoli.csv`: Filtered metadata containing only *E. coli* records

---

#### `split_ecoli_by_type.py`
**Purpose**: Splits *E. coli* metadata into separate files for plasmids and chromosomes.

**Usage**:
```bash
python metadata_handling/split_ecoli_by_type.py \
  -i assemblies/metadata_updated_ecoli.csv
```

**Output**:
- `metadata_updated_ecoli_plasmids.csv`: Plasmid sequences only
- `metadata_updated_ecoli_chromosomes.csv`: Chromosome sequences only

---

#### `create_metadata_updated_ecoli_systems_detail.py`
**Purpose**: Generates detailed metadata by merging *E. coli* metadata with DefenseFinder system results. Creates one row per defense system per contig for detailed analysis.

**Columns added**:
- `type`: Defense system type
- `subtype`: Defense system subtype
- `activity`: System activity classification
- `sys_beg`, `sys_end`: System genomic coordinates
- `protein_in_syst`: Proteins in the system
- `genes_count_per_system`: Number of genes per system
- `name_of_profiles_in_sys`: HMM profile names

**Usage**:
```bash
cd assemblies/
python ../scripts/metadata_handling/create_metadata_updated_ecoli_systems_detail.py
```

**Requirements**:
- `metadata_updated_ecoli.csv` must exist
- `*_defense_finder_systems.tsv` files must be present in the directory

**Output**:
- `metadata_updated_ecoli_systems_detail.csv`: Detailed system-level metadata

---

### R Analysis Scripts

All R analysis scripts are located in `R_analysis_scripts/` and are used to generate figures for the manuscript. Scripts reference figure numbers in comments.

#### Setup Files

**`dependencies.R`**
- Centralized package management for all R scripts
- Automatically installs missing packages
- Loads all required libraries

**`utils.R`**
- Shared utility functions used across analysis scripts:
  - `read_metadata()`: Reads CSV files from assemblies/ directory
  - `ensure_dir()`: Creates directories if they don't exist
  - `star()`: Converts p-values to significance stars (***, **, *, ns)

#### Analysis Scripts

**`plasmids_vs_chromosomes_enrichment.Rmd`**
- **Generates**: Figure 1, Supplementary Figure S5
- **Analysis**: Chi-square tests comparing plasmid enrichment of:
  - Total gene counts
  - Defense system gene counts
  - ARG counts
- Includes subset analyses by niche

**`systems_enriched_on_plasmids.Rmd`**
- **Generates**: Figure 2, Supplementary Figure S6, Supplementary File 1
- **Analysis**: Permutation tests (n=10,000) for defense system enrichment on plasmids vs. chromosomes
- Implements Benjamini-Hochberg (BH) and Benjamini-Yekutieli (BY) FDR corrections
- Identifies systems significantly enriched on plasmids and chromosomes

**`heatmap_ARGs_PDSs.Rmd`**
- **Generates**: Figure 3A, Supplementary Figure S9
- **Analysis**: Co-occurrence heatmaps of ARGs and PDSs
- Separate analyses for plasmids and chromosomes
- Ordered by frequency to highlight common associations


**`sampling_plasmids_from_clusters.Rmd`**
- **Purpose**: Sub-samples one plasmid per cluster to reduce redundancy
- Handles identical groups and clusters hierarchically
- Creates `metadata_sampled_clusters.csv` for GAMM analysis

**`gamm_ARG_PDS.Rmd`**
- **Generates**: Figure 3B, Table 1
- **Analysis**: Generalized Additive Mixed Model (GAMM) predicting ARG count from:
  - Phage-defense system count
  - GC content (mean-centered)
  - Niche (BSI, livestock, wastewater)
  - Plasmid type (random effect)
- Uses Tweedie distribution with log link
- Includes DHARMa residual diagnostics
- Forest plot visualization of effect sizes


**`frequency_distribution.Rmd`**
- **Generates**: Multiple frequency distribution supplementary figures
- **Analysis**: Distribution of PDS types and ARG types on plasmids and chromosomes
- Highlights co-localization patterns
- Adds context on general plasmid length distribution in the dataset

#### Running R Scripts

All R Markdown files can be run individually or knit to HTML:

```R
# In RStudio: Open .Rmd file and click "Knit"

# Or run all chunks interactively:
# Open .Rmd file in RStudio and run chunks
```

**Important notes**:
- All scripts use `here()` for relative paths
- Scripts source `utils.R` for shared functions
- Session information is captured at the end of each script
- Set working directory to project root before running
- Figures are saved to `figures/` directory (created automatically)

---

## Citation

If you use these scripts, please cite the original paper:

**Enterobacterales plasmid sharing amongst human bloodstream infections, livestock, wastewater, and waterway niches in Oxfordshire, UK**
https://doi.org/10.7554/eLife.85302

And pre-print:

**Plasmids link antibiotic resistance genes and phage defense systems in E. coli**
https://doi.org/10.1101/2025.07.25.666796
